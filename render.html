<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Life Calendar - Wallpaper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', system-ui, sans-serif;
            color: #fff;
        }

        .message {
            text-align: center;
            padding: 20px;
        }

        .message h2 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .message p {
            color: #888;
            font-size: 14px;
        }

        .dimensions {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 12px;
            color: #666;
        }

        canvas {
            display: none;
        }

        /* Preview for browsers */
        .preview-img {
            max-width: 300px;
            max-height: 60vh;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas"></canvas>
    <img id="previewImg" class="preview-img" alt="Wallpaper Preview">
    <div class="message">
        <h2>✅ Wallpaper Generated</h2>
        <p>Your wallpaper is downloading...</p>
        <div class="dimensions" id="dimensionsInfo"></div>
    </div>

    <script type="module">
        import { renderYearCalendar } from './js/renderers/yearCalendar.js';
        import { renderLifeCalendar } from './js/renderers/lifeCalendar.js';
        import { renderGoalCountdown } from './js/renderers/goalCountdown.js';
        import { getDevice } from './js/utils/devices.js';

        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        const type = params.get('type') || 'year';
        const accentColor = '#' + (params.get('accent') || 'ff6b6b');

        // Support both width/height params and device ID
        let width, height;
        const widthParam = params.get('width');
        const heightParam = params.get('height');
        const deviceId = params.get('device') || 'iphone15';

        if (widthParam && heightParam) {
            // Use direct width/height parameters
            width = parseInt(widthParam);
            height = parseInt(heightParam);
        } else {
            // Fallback to device preset
            const device = getDevice(deviceId);
            width = device.width;
            height = device.height;
        }

        const canvas = document.getElementById('renderCanvas');

        // Create options with explicit dimensions
        const options = {
            accentColor,
            customWidth: width,
            customHeight: height,
            deviceId
        };

        // Render the calendar
        switch (type) {
            case 'year':
                renderYearCalendar(canvas, options);
                break;
            case 'life':
                const birth = params.get('birth');
                const expectancy = parseInt(params.get('expectancy')) || 80;
                renderLifeCalendar(canvas, {
                    ...options,
                    birthDate: birth ? new Date(birth) : new Date(1990, 0, 1),
                    lifeExpectancy: expectancy
                });
                break;
            case 'goal':
                const target = params.get('target');
                const title = params.get('title') || 'Goal';
                renderGoalCountdown(canvas, {
                    ...options,
                    targetDate: target ? new Date(target) : new Date(new Date().getFullYear(), 11, 31),
                    goalTitle: decodeURIComponent(title)
                });
                break;
        }

        // Display dimensions info
        document.getElementById('dimensionsInfo').textContent = `${width} × ${height} pixels`;

        // Convert canvas to PNG data URL
        const imageDataUrl = canvas.toDataURL('image/png');

        // Show preview
        const previewImg = document.getElementById('previewImg');
        previewImg.src = imageDataUrl;

        // Allow manual download by clicking the image
        previewImg.onclick = () => {
            const filename = `${type}-calendar-${width}x${height}.png`;
            const link = document.createElement('a');
            link.download = filename;
            link.href = imageDataUrl;
            link.click();
        };

        // Update message
        document.querySelector('.message p').textContent = 'Long-press image to save or set as wallpaper';

        // For iOS Shortcuts - also expose as blob URL for "Get Contents of URL"
        canvas.toBlob((blob) => {
            if (blob) {
                window.wallpaperBlob = blob;
                window.wallpaperUrl = URL.createObjectURL(blob);
            }
        }, 'image/png');
    </script>
</body>

</html>